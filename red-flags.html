<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link rel="icon" type="image/svg+xml" href="/public/favicon.svg"/>
    <title>Red Flags Criteria - Vetted</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet"/>
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --color-primary: #7f13ec;
            --color-primary-hover: #6b0fcc;
            --color-primary-dark: #4c0b8f;
            --color-primary-light: #a855f7;
            --color-accent: #d4af37;
            --color-accent-light: #f3e5ab;
            --color-accent-hover: #c9a227;
            --color-plum: #2a173b;
            --color-plum-light: #4a2c63;
            --color-plum-muted: rgba(42, 23, 59, 0.6);
            --color-bg-primary: #f7f4ed;
            --color-bg-secondary: #ffffff;
            --color-bg-tertiary: #f8f7f4;
            --color-bg-sidebar: var(--color-plum);
            --color-bg-card: var(--color-bg-secondary);
            --color-text-primary: var(--color-plum);
            --color-text-secondary: rgba(42, 23, 59, 0.6);
            --color-text-tertiary: rgba(42, 23, 59, 0.4);
            --color-text-inverse: #ffffff;
            --color-text-inverse-muted: rgba(255, 255, 255, 0.7);
            --color-border: rgba(42, 23, 59, 0.05);
            --color-border-hover: rgba(42, 23, 59, 0.15);
            --color-border-accent: rgba(212, 175, 55, 0.3);
            --color-success: #16a34a;
            --color-success-bg: #f0fdf4;
            --color-warning: #ca8a04;
            --color-warning-bg: #fefce8;
            --color-error: #dc2626;
            --color-error-bg: #fef2f2;
            --color-info: #2563eb;
            --color-info-bg: #eff6ff;
            --font-display: 'Manrope', system-ui, sans-serif;
            --font-serif: 'Playfair Display', Georgia, serif;
            --sidebar-width: 16rem;
            --sidebar-collapsed-width: 4.5rem;
        }

        html.dark {
            --color-primary: #9333ea;
            --color-primary-hover: #a855f7;
            --color-primary-dark: #7c3aed;
            --color-primary-light: #c084fc;
            --color-accent: #d4af37;
            --color-accent-light: #b8942e;
            --color-accent-hover: #e5c158;
            --color-plum: #f8f7f4;
            --color-plum-light: #e5e4e1;
            --color-plum-muted: rgba(248, 247, 244, 0.6);
            --color-bg-primary: #1a1625;
            --color-bg-secondary: #241e30;
            --color-bg-tertiary: #2d2640;
            --color-bg-sidebar: #13101a;
            --color-bg-card: #241e30;
            --color-text-primary: #f8f7f4;
            --color-text-secondary: rgba(248, 247, 244, 0.7);
            --color-text-tertiary: rgba(248, 247, 244, 0.5);
            --color-text-inverse: #ffffff;
            --color-text-inverse-muted: rgba(255, 255, 255, 0.7);
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-border-accent: rgba(212, 175, 55, 0.4);
            --color-success: #22c55e;
            --color-success-bg: rgba(34, 197, 94, 0.15);
            --color-warning: #eab308;
            --color-warning-bg: rgba(234, 179, 8, 0.15);
            --color-error: #ef4444;
            --color-error-bg: rgba(239, 68, 68, 0.15);
            --color-info: #3b82f6;
            --color-info-bg: rgba(59, 130, 246, 0.15);
            color-scheme: dark;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .icon-filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-accent); border-radius: 9999px; }

        .sidebar-transition { transition: width 300ms ease, padding 300ms ease; }
        .sidebar-collapsed .sidebar-label { opacity: 0; width: 0; overflow: hidden; }
        .sidebar-expanded .sidebar-label { opacity: 1; width: auto; transition: opacity 200ms ease 100ms; }
        .sidebar-collapsed .sidebar-hideable { display: none; }
        .sidebar-collapsed .sidebar-collapse-icon { transform: rotate(180deg); }
        .sidebar-collapsed .sidebar-logo { justify-content: center; padding-left: 0; padding-right: 0; }
        .sidebar-collapsed .sidebar-nav { padding-left: 0.5rem; padding-right: 0.5rem; }
        .sidebar-collapsed .sidebar-nav-item { justify-content: center; padding-left: 0; padding-right: 0; gap: 0; }
        .sidebar-collapsed .sidebar-bottom { padding-left: 0.5rem; padding-right: 0.5rem; }
        .sidebar-collapsed .sidebar-profile { justify-content: center; }
        .sidebar-collapsed .sidebar-collapse-btn { justify-content: center; gap: 0; }
        .sidebar-collapsed .sidebar-collapsed-show { display: flex !important; }
        .theme-btn-active { background: rgba(255, 255, 255, 0.2); }
        .theme-btn-active span { color: var(--color-accent) !important; }

        /* Drag and Drop Styles */
        .criteria-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease, background-color 0.2s ease;
            cursor: grab;
            user-select: none;
        }
        .criteria-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .criteria-card:active {
            cursor: grabbing;
        }
        .criteria-card.dragging {
            opacity: 0.4;
            transform: scale(0.98);
        }
        /* Column-specific drag-over colors - Green for adding, Red for removing */
        [data-column="active"] .criteria-card.drag-over,
        .drop-zone[data-column="active"] .criteria-card.drag-over {
            border-top: 3px solid var(--color-success) !important;
            margin-top: -3px;
        }
        [data-column="available"] .criteria-card.drag-over,
        .drop-zone[data-column="available"] .criteria-card.drag-over {
            border-top: 3px solid var(--color-error) !important;
            margin-top: -3px;
        }

        /* Drop zone highlight */
        .drop-zone {
            transition: background-color 0.2s ease, border-color 0.2s ease;
            min-height: 200px;
        }
        .drop-zone[data-column="active"].drag-over-zone {
            background: rgba(22, 163, 74, 0.05);
        }
        .drop-zone[data-column="active"].drag-over-zone::after {
            content: 'Drop here';
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            inset: 0;
            background: rgba(22, 163, 74, 0.05);
            color: var(--color-success);
            font-weight: 600;
            pointer-events: none;
        }
        .drop-zone[data-column="available"].drag-over-zone {
            background: rgba(220, 38, 38, 0.05);
        }
        .drop-zone[data-column="available"].drag-over-zone::after {
            content: 'Drop here';
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            inset: 0;
            background: rgba(220, 38, 38, 0.05);
            color: var(--color-error);
            font-weight: 600;
            pointer-events: none;
        }

        /* Animation for adding/removing */
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        @keyframes flashRed {
            0% { background-color: var(--color-error); }
            100% { background-color: var(--color-bg-tertiary); }
        }
        @keyframes flashGreen {
            0% { background-color: var(--color-success); }
            100% { background-color: var(--color-bg-tertiary); }
        }
        .slide-in-left { animation: slideInLeft 0.3s ease forwards; }
        .slide-in-right { animation: slideInRight 0.3s ease forwards; }
        .fade-out { animation: fadeOut 0.2s ease forwards; }
        .flash-red { animation: flashRed 1s ease forwards; }
        .flash-green { animation: flashGreen 1s ease forwards; }

        /* Column styling */
        .column-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            color: var(--color-text-tertiary);
        }

        /* Drag handle */
        .drag-handle {
            cursor: grab;
            opacity: 0.4;
            transition: opacity 0.2s;
        }
        .criteria-card:hover .drag-handle {
            opacity: 1;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': 'var(--color-primary)',
                        'primary-hover': 'var(--color-primary-hover)',
                        'primary-light': 'var(--color-primary-light)',
                        'accent': 'var(--color-accent)',
                        'accent-light': 'var(--color-accent-light)',
                        'plum': 'var(--color-plum)',
                        'bg-primary': 'var(--color-bg-primary)',
                        'bg-secondary': 'var(--color-bg-secondary)',
                        'bg-tertiary': 'var(--color-bg-tertiary)',
                        'bg-sidebar': 'var(--color-bg-sidebar)',
                        'bg-card': 'var(--color-bg-card)',
                        'text-primary': 'var(--color-text-primary)',
                        'text-secondary': 'var(--color-text-secondary)',
                        'text-tertiary': 'var(--color-text-tertiary)',
                        'text-inverse': 'var(--color-text-inverse)',
                        'text-inverse-muted': 'var(--color-text-inverse-muted)',
                        'border-default': 'var(--color-border)',
                        'border-hover': 'var(--color-border-hover)',
                        'success': 'var(--color-success)',
                        'success-bg': 'var(--color-success-bg)',
                        'warning': 'var(--color-warning)',
                        'error': 'var(--color-error)',
                        'error-bg': 'var(--color-error-bg)',
                    },
                    fontFamily: {
                        'display': 'var(--font-display)',
                        'serif': 'var(--font-serif)',
                    },
                    width: {
                        'sidebar': 'var(--sidebar-width)',
                        'sidebar-collapsed': 'var(--sidebar-collapsed-width)',
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-bg-primary text-text-primary font-display antialiased overflow-hidden">
    <div class="flex h-screen w-full">
        <!-- Sidebar -->
        <aside id="sidebar" class="hidden lg:flex flex-col w-sidebar bg-bg-sidebar text-text-inverse h-full shrink-0 sidebar-transition sidebar-expanded">
            <!-- Logo -->
            <div class="sidebar-logo p-6 pb-4 cursor-pointer hover:bg-white/5 transition-colors duration-200 flex items-center gap-3" onclick="toggleSidebar()">
                <span class="material-symbols-outlined text-accent text-3xl shrink-0 icon-filled">verified_user</span>
                <div class="sidebar-label sidebar-hideable">
                    <h1 class="font-serif text-2xl font-bold text-text-inverse">Vetted</h1>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav flex-1 px-4 py-6 flex flex-col gap-1">
                <a class="sidebar-nav-item flex items-center gap-4 px-4 py-3 rounded-lg text-text-inverse-muted hover:bg-white/5 hover:text-text-inverse transition-all duration-200" href="app.html" title="Profiles">
                    <span class="material-symbols-outlined shrink-0">dashboard</span>
                    <span class="font-medium sidebar-label">Profiles</span>
                </a>
                <a class="sidebar-nav-item flex items-center gap-4 px-4 py-3 rounded-lg text-text-inverse-muted hover:bg-white/5 hover:text-text-inverse transition-all duration-200" href="archives.html" title="Archives">
                    <span class="material-symbols-outlined shrink-0">inventory_2</span>
                    <span class="font-medium sidebar-label">Archives</span>
                </a>

                <!-- Criteria Dropdown -->
                <div class="mt-2">
                    <button onclick="toggleCriteriaDropdown()" class="sidebar-nav-item w-full flex items-center gap-4 px-4 py-3 rounded-lg bg-white/10 text-text-inverse transition-all duration-200" title="Criteria">
                        <span class="material-symbols-outlined shrink-0">checklist</span>
                        <span class="font-medium sidebar-label flex-1 text-left">Criteria</span>
                        <span class="material-symbols-outlined text-lg sidebar-label transition-transform duration-200" id="criteria-chevron">expand_more</span>
                    </button>
                    <div id="criteria-dropdown" class="overflow-hidden transition-all duration-200 max-h-96">
                        <div class="pl-4 mt-1 space-y-1">
                            <a class="sidebar-nav-item flex items-center gap-4 px-4 py-2.5 rounded-lg text-text-inverse-muted hover:bg-white/5 hover:text-text-inverse transition-all duration-200" href="green-flags.html" title="Green Flags">
                                <span class="material-symbols-outlined text-success shrink-0">thumb_up</span>
                                <span class="font-medium sidebar-label text-sm">Green Flags</span>
                            </a>
                            <a class="sidebar-nav-item flex items-center gap-4 px-4 py-2.5 rounded-lg bg-white/5 text-text-inverse transition-all duration-200" href="red-flags.html" title="Red Flags">
                                <span class="material-symbols-outlined text-error shrink-0">flag</span>
                                <span class="font-medium sidebar-label text-sm">Red Flags</span>
                            </a>
                            <a class="sidebar-nav-item flex items-center gap-4 px-4 py-2.5 rounded-lg text-text-inverse-muted hover:bg-white/5 hover:text-text-inverse transition-all duration-200" href="dealbreakers.html" title="Dealbreakers">
                                <span class="material-symbols-outlined text-primary-light shrink-0">block</span>
                                <span class="font-medium sidebar-label text-sm">Dealbreakers</span>
                            </a>
                            <a class="sidebar-nav-item flex items-center gap-4 px-4 py-2.5 rounded-lg text-text-inverse-muted hover:bg-white/5 hover:text-text-inverse transition-all duration-200" href="investment.html" title="Investment">
                                <span class="material-symbols-outlined text-accent shrink-0">trending_up</span>
                                <span class="font-medium sidebar-label text-sm">Investment</span>
                            </a>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Bottom Section -->
            <div class="sidebar-bottom p-4 border-t border-white/10">
                <!-- Theme Toggle Row -->
                <div class="flex items-center justify-between mb-4 sidebar-hideable">
                    <div class="flex items-center gap-1 bg-white/10 rounded-lg p-1">
                        <button onclick="setTheme('light')" id="theme-light" class="w-10 h-10 flex items-center justify-center rounded-md hover:bg-white/10 transition-colors duration-200" title="Light mode">
                            <span class="material-symbols-outlined text-xl text-text-inverse-muted">light_mode</span>
                        </button>
                        <button onclick="setTheme('dark')" id="theme-dark" class="w-10 h-10 flex items-center justify-center rounded-md hover:bg-white/10 transition-colors duration-200" title="Dark mode">
                            <span class="material-symbols-outlined text-xl text-text-inverse-muted">dark_mode</span>
                        </button>
                    </div>
                    <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-white/10 transition-colors duration-200" title="Collapse sidebar">
                        <span class="material-symbols-outlined sidebar-collapse-icon transition-transform duration-300 text-text-inverse-muted hover:text-text-inverse">keyboard_double_arrow_left</span>
                    </button>
                </div>

                <!-- Collapsed state: just collapse icon -->
                <button onclick="toggleSidebar()" class="sidebar-collapse-btn hidden sidebar-collapsed-show w-full flex items-center justify-center py-2 rounded-lg hover:bg-white/10 transition-all duration-200 text-text-inverse-muted hover:text-text-inverse mb-4" title="Expand sidebar">
                    <span class="material-symbols-outlined sidebar-collapse-icon transition-transform duration-300 shrink-0">keyboard_double_arrow_left</span>
                </button>

                <!-- User Profile -->
                <a href="settings.html" class="sidebar-profile flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition-colors duration-200 sidebar-hideable">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-accent to-accent-light flex items-center justify-center text-bg-sidebar font-bold text-sm shrink-0">
                        U
                    </div>
                    <div class="sidebar-label flex-1 min-w-0">
                        <p class="font-medium text-text-inverse text-sm truncate">User</p>
                        <p class="text-xs text-text-inverse-muted">Settings</p>
                    </div>
                    <span class="material-symbols-outlined text-text-inverse-muted text-lg sidebar-label">chevron_right</span>
                </a>
            </div>
        </aside>

        <script>
            function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const isExpanded = sidebar.classList.contains('sidebar-expanded');
                if (isExpanded) {
                    sidebar.classList.remove('sidebar-expanded', 'w-sidebar');
                    sidebar.classList.add('sidebar-collapsed', 'w-sidebar-collapsed');
                } else {
                    sidebar.classList.remove('sidebar-collapsed', 'w-sidebar-collapsed');
                    sidebar.classList.add('sidebar-expanded', 'w-sidebar');
                }
            }

            function toggleCriteriaDropdown() {
                const dropdown = document.getElementById('criteria-dropdown');
                const chevron = document.getElementById('criteria-chevron');
                const isOpen = dropdown.style.maxHeight !== '0px';

                if (isOpen) {
                    dropdown.style.maxHeight = '0px';
                    chevron.style.transform = 'rotate(-90deg)';
                } else {
                    dropdown.style.maxHeight = '400px';
                    chevron.style.transform = 'rotate(0deg)';
                }
            }

            function setTheme(theme) {
                const html = document.documentElement;
                if (theme === 'dark') {
                    html.classList.remove('light');
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                    html.classList.add('light');
                }
                localStorage.setItem('theme', theme);
                updateSidebarThemeButtons(theme);
            }

            function updateSidebarThemeButtons(theme) {
                const lightBtn = document.getElementById('theme-light');
                const darkBtn = document.getElementById('theme-dark');
                if (lightBtn && darkBtn) {
                    lightBtn.classList.remove('theme-btn-active');
                    darkBtn.classList.remove('theme-btn-active');
                    if (theme === 'light') lightBtn.classList.add('theme-btn-active');
                    if (theme === 'dark') darkBtn.classList.add('theme-btn-active');
                }
            }

            (function() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                setTheme(savedTheme);
            })();
        </script>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden">
            <!-- Header -->
            <div class="shrink-0 p-6 pb-4 border-b border-border-default bg-bg-card">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-error/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-error text-3xl icon-filled">flag</span>
                    </div>
                    <div>
                        <h1 class="font-serif text-3xl font-bold text-text-primary">Red Flags</h1>
                        <p class="text-text-secondary">Manage warning signs to track in your evaluations</p>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="flex-1 overflow-hidden p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Left Column: Active Criteria -->
                    <div class="flex flex-col bg-bg-card rounded-2xl border border-border-default shadow-sm overflow-hidden">
                        <div class="column-header shrink-0 p-4 border-b border-border-default bg-bg-sidebar">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-accent">check_circle</span>
                                    <h2 class="font-semibold text-text-inverse">Active Criteria</h2>
                                </div>
                                <span id="active-count" class="px-2.5 py-1 bg-accent text-bg-sidebar text-xs font-bold rounded-full">0</span>
                            </div>
                            <p class="text-xs text-text-inverse-muted mt-1">Drag to reorder • Click − to remove</p>
                        </div>
                        <div id="active-list" class="flex-1 overflow-y-auto p-4 drop-zone relative" data-column="active">
                            <!-- Active criteria cards rendered here -->
                        </div>
                    </div>

                    <!-- Right Column: Available Criteria -->
                    <div class="flex flex-col bg-bg-card rounded-2xl border border-border-default shadow-sm overflow-hidden">
                        <div class="column-header shrink-0 p-4 border-b border-border-default bg-bg-sidebar">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-accent">playlist_add</span>
                                    <h2 class="font-semibold text-text-inverse">Available</h2>
                                </div>
                                <span id="available-count" class="px-2.5 py-1 bg-text-inverse-muted text-bg-sidebar text-xs font-bold rounded-full">0</span>
                            </div>
                            <p class="text-xs text-text-inverse-muted mt-1">Click + to add to active list</p>
                        </div>

                        <!-- Add Custom Input -->
                        <div class="shrink-0 p-4 border-b border-border-default bg-bg-sidebar">
                            <form onsubmit="addCustomFlag(event)" class="flex gap-2">
                                <input type="text" id="custom-input" placeholder="Add your own red flag..." class="flex-1 px-4 py-2.5 bg-bg-card border border-border-default rounded-xl text-text-primary placeholder-text-tertiary text-sm focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20" />
                                <button type="submit" class="px-4 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold hover:bg-primary-hover transition-colors flex items-center gap-1 shrink-0">
                                    <span class="material-symbols-outlined text-lg">add</span>
                                    Add
                                </button>
                            </form>
                        </div>

                        <div id="available-list" class="flex-1 overflow-y-auto p-4 drop-zone relative" data-column="available">
                            <!-- Available criteria cards rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script type="module">
        import { CriteriaStore } from './src/js/criteria-store.js';
        import { redFlags, getDefaultRedFlags } from './src/data/red-flags.js';

        const STORAGE_KEY = 'vetted_red_flags_order';
        let activeItems = [];
        let availableItems = [];
        let draggedItem = null;
        let draggedElement = null;
        let placeholder = null;

        // Load state
        function loadState() {
            const defaultFlags = getDefaultRedFlags();
            const defaultIds = defaultFlags.map(f => f.id);
            const customItems = CriteriaStore.getCustomItems('redFlags');

            // Combine all items
            const allItems = [...redFlags, ...customItems];

            // Get saved order
            const savedOrder = localStorage.getItem(STORAGE_KEY);
            let activeIds;

            if (savedOrder) {
                try {
                    activeIds = JSON.parse(savedOrder);
                } catch (e) {
                    activeIds = [...defaultIds];
                }
            } else {
                activeIds = [...defaultIds];
            }

            // Build active and available lists
            activeItems = [];
            availableItems = [];

            // Add active items in saved order
            activeIds.forEach(id => {
                const item = allItems.find(i => i.id === id);
                if (item) activeItems.push(item);
            });

            // Add remaining items to available
            allItems.forEach(item => {
                if (!activeIds.includes(item.id)) {
                    availableItems.push(item);
                }
            });
        }

        // Save state
        function saveState() {
            const activeIds = activeItems.map(i => i.id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(activeIds));
        }

        // Create a card element
        function createCard(item, isActive) {
            const card = document.createElement('div');
            card.className = 'criteria-card bg-bg-tertiary border border-border-default rounded-xl p-4 mb-3 flex items-center gap-3';
            card.setAttribute('draggable', 'true');
            card.dataset.id = item.id;
            card.dataset.column = isActive ? 'active' : 'available';

            const isCustom = item.isCustom || item.id.startsWith('custom-');

            card.innerHTML = `
                <span class="drag-handle material-symbols-outlined text-text-tertiary text-lg shrink-0">drag_indicator</span>
                <span class="flex-1 text-text-primary text-sm leading-relaxed">${escapeHtml(item.label)}</span>
                ${isCustom ? `
                    <button class="delete-btn p-2 rounded-lg hover:bg-error-bg transition-colors text-text-tertiary hover:text-error" title="Delete">
                        <span class="material-symbols-outlined text-lg">delete</span>
                    </button>
                ` : ''}
                <button class="toggle-btn p-2 rounded-lg transition-colors ${isActive ? 'hover:bg-success-bg text-text-tertiary hover:text-success' : 'hover:bg-primary/10 text-text-tertiary hover:text-primary'}" title="${isActive ? 'Remove' : 'Add'}">
                    <span class="material-symbols-outlined text-xl">${isActive ? 'remove_circle' : 'add_circle'}</span>
                </button>
            `;

            // Toggle button
            card.querySelector('.toggle-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                animateToggle(item.id, card, isActive);
            });

            // Delete button
            const deleteBtn = card.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCustomItem(item.id, card);
                });
            }

            // Drag events
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('dragleave', handleDragLeave);
            card.addEventListener('drop', handleDrop);

            return card;
        }

        // Animate toggle between columns
        function animateToggle(itemId, card, wasActive) {
            card.classList.add('fade-out');

            setTimeout(() => {
                if (wasActive) {
                    // Move to available
                    const idx = activeItems.findIndex(i => i.id === itemId);
                    if (idx > -1) {
                        const item = activeItems.splice(idx, 1)[0];
                        availableItems.unshift(item);
                    }
                } else {
                    // Move to active (add to top)
                    const idx = availableItems.findIndex(i => i.id === itemId);
                    if (idx > -1) {
                        const item = availableItems.splice(idx, 1)[0];
                        activeItems.unshift(item);
                    }
                }

                saveState();
                render();

                // Animate the new card with flash
                setTimeout(() => {
                    const newCard = document.querySelector(`[data-id="${itemId}"]`);
                    if (newCard) {
                        newCard.classList.add(wasActive ? 'slide-in-right' : 'slide-in-left');
                        // Flash green when adding to active, red when removing
                        newCard.classList.add(wasActive ? 'flash-red' : 'flash-green');
                    }
                }, 50);
            }, 200);
        }

        // Delete custom item
        function deleteCustomItem(itemId, card) {
            if (!confirm('Delete this custom red flag?')) return;

            card.classList.add('fade-out');
            setTimeout(() => {
                CriteriaStore.removeCustomItem('redFlags', itemId);
                activeItems = activeItems.filter(i => i.id !== itemId);
                availableItems = availableItems.filter(i => i.id !== itemId);
                saveState();
                render();
            }, 200);
        }

        // Add custom flag
        window.addCustomFlag = function(e) {
            e.preventDefault();
            const input = document.getElementById('custom-input');
            const label = input.value.trim();
            if (!label) return;

            const newItem = CriteriaStore.addCustomItem('redFlags', { label, icon: 'flag' });
            availableItems.unshift(newItem);
            input.value = '';
            render();

            // Animate
            setTimeout(() => {
                const newCard = document.querySelector(`[data-id="${newItem.id}"]`);
                if (newCard) {
                    newCard.classList.add('slide-in-right');
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 50);
        };

        // Drag handlers
        function handleDragStart(e) {
            draggedItem = e.target.dataset.id;
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drag-over, .drag-over-zone').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-zone');
            });
            draggedItem = null;
            draggedElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const card = e.target.closest('.criteria-card');
            if (card && card !== draggedElement) {
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                card.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const card = e.target.closest('.criteria-card');
            if (card) {
                card.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            document.querySelectorAll('.drag-over, .drag-over-zone').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-zone');
            });

            if (!draggedItem) return;

            const dropTarget = e.target.closest('.criteria-card') || e.target.closest('.drop-zone');
            if (!dropTarget) return;

            const sourceColumn = draggedElement.dataset.column;
            const targetColumn = dropTarget.dataset.column || dropTarget.closest('.drop-zone')?.dataset.column;

            if (!targetColumn) return;

            // Find and remove the item from source
            let item;
            if (sourceColumn === 'active') {
                const idx = activeItems.findIndex(i => i.id === draggedItem);
                if (idx > -1) item = activeItems.splice(idx, 1)[0];
            } else {
                const idx = availableItems.findIndex(i => i.id === draggedItem);
                if (idx > -1) item = availableItems.splice(idx, 1)[0];
            }

            if (!item) return;

            // Determine if crossing columns
            const crossingColumns = sourceColumn !== targetColumn;

            // Insert into target
            if (targetColumn === 'active') {
                if (dropTarget.classList.contains('criteria-card')) {
                    const targetId = dropTarget.dataset.id;
                    const idx = activeItems.findIndex(i => i.id === targetId);
                    activeItems.splice(idx, 0, item);
                } else {
                    activeItems.push(item);
                }
            } else {
                if (dropTarget.classList.contains('criteria-card')) {
                    const targetId = dropTarget.dataset.id;
                    const idx = availableItems.findIndex(i => i.id === targetId);
                    availableItems.splice(idx, 0, item);
                } else {
                    availableItems.unshift(item);
                }
            }

            saveState();
            render();

            // Flash animation when crossing columns
            if (crossingColumns) {
                setTimeout(() => {
                    const newCard = document.querySelector(`[data-id="${item.id}"]`);
                    if (newCard) {
                        newCard.classList.add(targetColumn === 'active' ? 'flash-green' : 'flash-red');
                    }
                }, 50);
            }
        }

        // Setup drop zones
        function setupDropZones() {
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!e.target.closest('.criteria-card')) {
                        zone.classList.add('drag-over-zone');
                    }
                });
                zone.addEventListener('dragleave', (e) => {
                    if (!zone.contains(e.relatedTarget)) {
                        zone.classList.remove('drag-over-zone');
                    }
                });
                zone.addEventListener('drop', handleDrop);
            });
        }

        // Render
        function render() {
            const activeList = document.getElementById('active-list');
            const availableList = document.getElementById('available-list');

            // Clear
            activeList.innerHTML = '';
            availableList.innerHTML = '';

            // Render active
            if (activeItems.length === 0) {
                activeList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-symbols-outlined text-4xl mb-2">playlist_add</span>
                        <p class="text-sm">No active criteria</p>
                        <p class="text-xs mt-1">Add items from the right column</p>
                    </div>
                `;
            } else {
                activeItems.forEach(item => {
                    activeList.appendChild(createCard(item, true));
                });
            }

            // Render available
            if (availableItems.length === 0) {
                availableList.innerHTML = `
                    <div class="empty-state">
                        <span class="material-symbols-outlined text-4xl mb-2">check_circle</span>
                        <p class="text-sm">All criteria are active</p>
                        <p class="text-xs mt-1">Add custom criteria above</p>
                    </div>
                `;
            } else {
                availableItems.forEach(item => {
                    availableList.appendChild(createCard(item, false));
                });
            }

            // Update counts
            document.getElementById('active-count').textContent = activeItems.length;
            document.getElementById('available-count').textContent = availableItems.length;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadState();
        render();
        setupDropZones();
    </script>
</body>
</html>
