<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Profile Detail - Vetted</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet"/>
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --color-primary: #7f13ec;
            --color-primary-hover: #6b0fcc;
            --color-primary-dark: #4c0b8f;
            --color-primary-light: #a855f7;
            --color-accent: #d4af37;
            --color-accent-light: #f3e5ab;
            --color-accent-hover: #c9a227;
            --color-plum: #2a173b;
            --color-plum-light: #4a2c63;
            --color-plum-muted: rgba(42, 23, 59, 0.6);
            --color-bg-primary: #f7f4ed;
            --color-bg-secondary: #ffffff;
            --color-bg-tertiary: #f8f7f4;
            --color-bg-sidebar: var(--color-plum);
            --color-bg-card: var(--color-bg-secondary);
            --color-text-primary: var(--color-plum);
            --color-text-secondary: rgba(42, 23, 59, 0.6);
            --color-text-tertiary: rgba(42, 23, 59, 0.4);
            --color-text-inverse: #ffffff;
            --color-text-inverse-muted: rgba(255, 255, 255, 0.7);
            --color-border: rgba(42, 23, 59, 0.05);
            --color-border-hover: rgba(42, 23, 59, 0.15);
            --color-border-accent: rgba(212, 175, 55, 0.3);
            --color-success: #16a34a;
            --color-success-bg: #f0fdf4;
            --color-warning: #ca8a04;
            --color-warning-bg: #fefce8;
            --color-error: #dc2626;
            --color-error-bg: #fef2f2;
            --color-info: #2563eb;
            --color-info-bg: #eff6ff;
            --font-display: 'Manrope', system-ui, sans-serif;
            --font-serif: 'Playfair Display', Georgia, serif;
            --sidebar-width: 16rem;
            --sidebar-collapsed-width: 4.5rem;
        }

        html.dark {
            --color-primary: #9333ea;
            --color-primary-hover: #a855f7;
            --color-plum: #f8f7f4;
            --color-plum-light: #e5e4e1;
            --color-plum-muted: rgba(248, 247, 244, 0.6);
            --color-bg-primary: #1a1625;
            --color-bg-secondary: #241e30;
            --color-bg-tertiary: #2d2640;
            --color-bg-sidebar: #13101a;
            --color-bg-card: #241e30;
            --color-text-primary: #f8f7f4;
            --color-text-secondary: rgba(248, 247, 244, 0.7);
            --color-text-tertiary: rgba(248, 247, 244, 0.5);
            --color-border: rgba(255, 255, 255, 0.08);
            --color-border-hover: rgba(255, 255, 255, 0.15);
            --color-success: #22c55e;
            --color-success-bg: rgba(34, 197, 94, 0.15);
            --color-warning: #eab308;
            --color-warning-bg: rgba(234, 179, 8, 0.15);
            --color-error: #ef4444;
            --color-error-bg: rgba(239, 68, 68, 0.15);
            --color-info: #3b82f6;
            --color-info-bg: rgba(59, 130, 246, 0.15);
            color-scheme: dark;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .icon-filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-accent); border-radius: 9999px; }

        .sidebar-transition { transition: width 300ms ease, padding 300ms ease; }
        .sidebar-collapsed .sidebar-label { opacity: 0; width: 0; overflow: hidden; }
        .sidebar-expanded .sidebar-label { opacity: 1; width: auto; transition: opacity 200ms ease 100ms; }
        .sidebar-collapsed .sidebar-hideable { display: none; }
        .sidebar-collapsed .sidebar-collapse-icon { transform: rotate(180deg); }
        .sidebar-collapsed .sidebar-logo { justify-content: center; padding-left: 0; padding-right: 0; }
        .sidebar-collapsed .sidebar-nav { padding-left: 0.5rem; padding-right: 0.5rem; }
        .sidebar-collapsed .sidebar-nav-item { justify-content: center; padding-left: 0; padding-right: 0; gap: 0; }
        .sidebar-collapsed .sidebar-bottom { padding-left: 0.5rem; padding-right: 0.5rem; }
        .sidebar-collapsed .sidebar-collapse-btn { justify-content: center; gap: 0; }
        .sidebar-collapsed .sidebar-collapsed-show { display: flex !important; }
        .theme-btn-active { background: rgba(255, 255, 255, 0.2); }
        .theme-btn-active span { color: var(--color-accent) !important; }

        .modal-backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }

        /* Tab styles */
        .tab-btn {
            transition: all 200ms ease;
        }
        .tab-btn.active-green {
            background: var(--color-success-bg);
            border-bottom-color: var(--color-success);
            color: var(--color-success);
        }
        .tab-btn.active-red {
            background: var(--color-error-bg);
            border-bottom-color: var(--color-error);
            color: var(--color-error);
        }
        .tab-btn.active-dealbreakers {
            background: rgba(127, 19, 236, 0.1);
            border-bottom-color: var(--color-primary);
            color: var(--color-primary);
        }
        .tab-btn.active-investment {
            background: var(--color-info-bg);
            border-bottom-color: var(--color-info);
            color: var(--color-info);
        }
        .tab-btn:not([class*="active-"]):hover {
            background: var(--color-bg-tertiary);
        }

        /* Flag item hover */
        .flag-item {
            transition: background 150ms ease;
        }
        .flag-item:hover {
            background: var(--color-bg-tertiary);
        }

        /* Checkbox styling */
        .flag-checkbox,
        .investment-checkbox {
            display: none;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': 'var(--color-primary)',
                        'primary-hover': 'var(--color-primary-hover)',
                        'primary-dark': 'var(--color-primary-dark)',
                        'primary-light': 'var(--color-primary-light)',
                        'accent': 'var(--color-accent)',
                        'accent-light': 'var(--color-accent-light)',
                        'plum': 'var(--color-plum)',
                        'plum-light': 'var(--color-plum-light)',
                        'bg-primary': 'var(--color-bg-primary)',
                        'bg-secondary': 'var(--color-bg-secondary)',
                        'bg-tertiary': 'var(--color-bg-tertiary)',
                        'bg-sidebar': 'var(--color-bg-sidebar)',
                        'bg-card': 'var(--color-bg-card)',
                        'text-primary': 'var(--color-text-primary)',
                        'text-secondary': 'var(--color-text-secondary)',
                        'text-tertiary': 'var(--color-text-tertiary)',
                        'text-inverse': 'var(--color-text-inverse)',
                        'text-inverse-muted': 'var(--color-text-inverse-muted)',
                        'border-default': 'var(--color-border)',
                        'border-hover': 'var(--color-border-hover)',
                        'success': 'var(--color-success)',
                        'success-bg': 'var(--color-success-bg)',
                        'warning': 'var(--color-warning)',
                        'warning-bg': 'var(--color-warning-bg)',
                        'error': 'var(--color-error)',
                        'error-bg': 'var(--color-error-bg)',
                        'info': 'var(--color-info)',
                        'info-bg': 'var(--color-info-bg)',
                    },
                    fontFamily: {
                        'display': 'var(--font-display)',
                        'serif': 'var(--font-serif)',
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-bg-primary text-text-primary font-display antialiased overflow-hidden">
    <div class="flex h-screen w-full">
        <!-- Sidebar -->
        <aside id="sidebar" class="hidden lg:flex flex-col w-64 bg-bg-sidebar text-text-inverse h-full shrink-0 sidebar-transition sidebar-expanded">
            <div class="sidebar-logo p-6 pb-4 cursor-pointer hover:bg-white/5 transition-colors duration-200 flex items-center gap-3" onclick="toggleSidebar()">
                <span class="material-symbols-outlined text-accent text-3xl shrink-0">verified_user</span>
                <div class="sidebar-label sidebar-hideable">
                    <h1 class="font-serif text-2xl font-bold text-text-inverse">Vetted</h1>
                    <p class="text-text-inverse-muted text-sm mt-1">Know Your Worth</p>
                </div>
            </div>

            <nav class="sidebar-nav flex-1 px-4 py-6 flex flex-col gap-1">
                <a class="sidebar-nav-item flex items-center gap-4 px-4 py-3 rounded-lg text-text-inverse-muted hover:bg-white/5 hover:text-text-inverse transition-all duration-200" href="app.html" title="Profiles">
                    <span class="material-symbols-outlined shrink-0">dashboard</span>
                    <span class="font-medium sidebar-label">Profiles</span>
                </a>
                <a class="sidebar-nav-item flex items-center gap-4 px-4 py-3 rounded-lg text-text-inverse-muted hover:bg-white/5 hover:text-text-inverse transition-all duration-200" href="archives.html" title="Archives">
                    <span class="material-symbols-outlined shrink-0">inventory_2</span>
                    <span class="font-medium sidebar-label">Archives</span>
                </a>
                <a class="sidebar-nav-item flex items-center gap-4 px-4 py-3 rounded-lg text-text-inverse-muted hover:bg-white/5 hover:text-text-inverse transition-all duration-200" href="settings.html" title="Settings">
                    <span class="material-symbols-outlined shrink-0">settings</span>
                    <span class="font-medium sidebar-label">Settings</span>
                </a>
                <div class="my-4 border-t border-white/10"></div>
                <a class="sidebar-nav-item flex items-center gap-4 px-4 py-3 rounded-lg text-text-inverse-muted hover:bg-white/5 hover:text-text-inverse transition-all duration-200" href="index.html" title="Home">
                    <span class="material-symbols-outlined shrink-0">home</span>
                    <span class="font-medium sidebar-label">Home</span>
                </a>
            </nav>

            <div class="sidebar-bottom p-4 border-t border-white/10">
                <div class="flex items-center justify-between mb-4 sidebar-hideable">
                    <div class="flex items-center gap-1 bg-white/10 rounded-lg p-1">
                        <button onclick="setTheme('light')" id="theme-light" class="w-10 h-10 flex items-center justify-center rounded-md hover:bg-white/10 transition-colors duration-200" title="Light mode">
                            <span class="material-symbols-outlined text-xl text-text-inverse-muted">light_mode</span>
                        </button>
                        <button onclick="setTheme('dark')" id="theme-dark" class="w-10 h-10 flex items-center justify-center rounded-md hover:bg-white/10 transition-colors duration-200" title="Dark mode">
                            <span class="material-symbols-outlined text-xl text-text-inverse-muted">dark_mode</span>
                        </button>
                    </div>
                    <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-white/10 transition-colors duration-200" title="Collapse sidebar">
                        <span class="material-symbols-outlined sidebar-collapse-icon transition-transform duration-300 text-text-inverse-muted hover:text-text-inverse">keyboard_double_arrow_left</span>
                    </button>
                </div>
                <button onclick="toggleSidebar()" class="sidebar-collapse-btn hidden sidebar-collapsed-show w-full flex items-center justify-center py-2 rounded-lg hover:bg-white/10 transition-all duration-200 text-text-inverse-muted hover:text-text-inverse mb-4" title="Expand sidebar">
                    <span class="material-symbols-outlined sidebar-collapse-icon transition-transform duration-300 shrink-0">keyboard_double_arrow_left</span>
                </button>
                <div class="sidebar-hideable text-center">
                    <p class="text-xs text-text-inverse-muted flex items-center justify-center gap-1">
                        <span class="material-symbols-outlined text-sm">lock</span>
                        Data stored locally
                    </p>
                </div>
            </div>
        </aside>

        <script>
            function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const isExpanded = sidebar.classList.contains('sidebar-expanded');
                if (isExpanded) {
                    sidebar.classList.remove('sidebar-expanded', 'w-64');
                    sidebar.classList.add('sidebar-collapsed', 'w-[72px]');
                } else {
                    sidebar.classList.remove('sidebar-collapsed', 'w-[72px]');
                    sidebar.classList.add('sidebar-expanded', 'w-64');
                }
            }

            function setTheme(theme) {
                const html = document.documentElement;
                if (theme === 'dark') {
                    html.classList.remove('light');
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                    html.classList.add('light');
                }
                localStorage.setItem('theme', theme);
                updateSidebarThemeButtons(theme);
            }

            function updateSidebarThemeButtons(theme) {
                const lightBtn = document.getElementById('theme-light');
                const darkBtn = document.getElementById('theme-dark');
                if (lightBtn && darkBtn) {
                    lightBtn.classList.remove('theme-btn-active');
                    darkBtn.classList.remove('theme-btn-active');
                    if (theme === 'light') lightBtn.classList.add('theme-btn-active');
                    if (theme === 'dark') darkBtn.classList.add('theme-btn-active');
                }
            }

            (function() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                setTheme(savedTheme);
            })();
        </script>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden">
            <div class="flex-1 overflow-y-auto p-6 lg:p-8">
                <div class="max-w-6xl mx-auto">
                    <!-- Back Button -->
                    <a href="app.html" class="inline-flex items-center gap-2 text-text-secondary hover:text-text-primary transition-colors duration-200 mb-6">
                        <span class="material-symbols-outlined text-xl">arrow_back</span>
                        <span class="font-medium">Back to Profiles</span>
                    </a>

                    <!-- Two Column Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Left Column: Profile Card (1/3) -->
                        <div class="lg:col-span-1">
                            <div class="bg-bg-card rounded-2xl border border-border-default shadow-card p-6 sticky top-6">
                                <!-- Avatar -->
                                <div class="flex flex-col items-center text-center mb-6">
                                    <div id="profile-avatar" class="h-24 w-24 rounded-full flex items-center justify-center text-white font-bold text-3xl mb-4">
                                        <!-- Avatar rendered by JS -->
                                    </div>
                                    <h1 id="profile-name" class="font-serif text-2xl font-bold text-text-primary mb-2">Loading...</h1>
                                    <div id="profile-grade" class="px-5 py-2 rounded-full text-xl font-bold mb-2">
                                        <!-- Grade rendered by JS -->
                                    </div>
                                    <p id="profile-grade-desc" class="text-sm text-text-secondary"></p>
                                </div>

                                <!-- Notes Section -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-text-primary mb-2">Notes</label>
                                    <textarea id="profile-notes" placeholder="Add private notes about this person..." rows="3" class="w-full px-4 py-3 bg-bg-tertiary border border-border-default rounded-xl text-text-primary placeholder-text-tertiary text-sm resize-none focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"></textarea>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex gap-2">
                                    <button onclick="showArchiveConfirm()" class="flex-1 px-3 py-2 bg-bg-tertiary text-text-secondary rounded-lg text-sm font-medium hover:bg-border-hover hover:text-text-primary transition-colors flex items-center justify-center gap-2">
                                        <span class="material-symbols-outlined text-lg">inventory_2</span>
                                        Archive
                                    </button>
                                    <button onclick="showDeleteConfirm()" class="flex-1 px-3 py-2 bg-error-bg text-error rounded-lg text-sm font-medium hover:bg-error hover:text-white transition-colors flex items-center justify-center gap-2">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Grade Breakdown (2/3) -->
                        <div class="lg:col-span-2">
                            <div class="bg-bg-card rounded-2xl border border-border-default shadow-card p-6">
                                <h2 class="font-serif text-xl font-bold text-text-primary mb-6">Grade Breakdown</h2>
                                <div id="grade-breakdown" class="space-y-5">
                                    <!-- Progress bars rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs Section -->
                    <div class="bg-bg-card rounded-2xl border border-border-default shadow-card overflow-hidden">
                        <!-- Tab Buttons -->
                        <div class="flex border-b border-border-default">
                            <button onclick="switchTab('green')" id="tab-green" class="tab-btn flex-1 px-4 py-4 text-sm font-semibold text-text-secondary border-b-2 border-transparent flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-success text-xl">thumb_up</span>
                                <span class="hidden sm:inline">Green Flags</span>
                                <span id="count-green" class="px-2 py-0.5 bg-success-bg text-success text-xs font-bold rounded-full">0</span>
                            </button>
                            <button onclick="switchTab('red')" id="tab-red" class="tab-btn flex-1 px-4 py-4 text-sm font-semibold text-text-secondary border-b-2 border-transparent flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-error text-xl">flag</span>
                                <span class="hidden sm:inline">Red Flags</span>
                                <span id="count-red" class="px-2 py-0.5 bg-error-bg text-error text-xs font-bold rounded-full">0</span>
                            </button>
                            <button onclick="switchTab('dealbreakers')" id="tab-dealbreakers" class="tab-btn flex-1 px-4 py-4 text-sm font-semibold text-text-secondary border-b-2 border-transparent flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-primary text-xl">block</span>
                                <span class="hidden sm:inline">Dealbreakers</span>
                                <span id="count-dealbreakers" class="px-2 py-0.5 bg-primary/10 text-primary text-xs font-bold rounded-full">0</span>
                            </button>
                            <button onclick="switchTab('investment')" id="tab-investment" class="tab-btn flex-1 px-4 py-4 text-sm font-semibold text-text-secondary border-b-2 border-transparent flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-info text-xl">trending_up</span>
                                <span class="hidden sm:inline">Investment</span>
                                <span id="count-investment" class="px-2 py-0.5 bg-info-bg text-info text-xs font-bold rounded-full">0</span>
                            </button>
                        </div>

                        <!-- Tab Content -->
                        <div id="tab-content">
                            <!-- Content rendered by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeConfirmModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-bg-card rounded-2xl shadow-xl w-full max-w-sm p-6 relative">
                <h2 id="confirm-title" class="font-serif text-xl font-bold text-text-primary mb-2">Confirm Action</h2>
                <p id="confirm-message" class="text-text-secondary text-sm mb-6">Are you sure?</p>
                <div class="flex gap-3">
                    <button onclick="closeConfirmModal()" class="flex-1 px-4 py-3 bg-bg-tertiary text-text-primary rounded-xl font-semibold hover:bg-border-hover transition-colors">
                        Cancel
                    </button>
                    <button id="confirm-action-btn" onclick="executeConfirmedAction()" class="flex-1 px-4 py-3 rounded-xl font-semibold transition-colors">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile JavaScript -->
    <script type="module">
        import { Store } from './src/js/store.js';
        import { CriteriaStore } from './src/js/criteria-store.js';
        import { getGradeColor, getGradeDescription } from './src/js/grading.js';
        import { getInitials, getAvatarColor, getProfileIdFromUrl, escapeHtml } from './src/js/utils.js';
        import { greenFlags, getDefaultGreenFlags } from './src/data/green-flags.js';
        import { redFlags, getDefaultRedFlags } from './src/data/red-flags.js';
        import { dealbreakers, getDefaultDealbreakers } from './src/data/dealbreakers.js';
        import { investmentStages, getDefaultInvestmentStages } from './src/data/investment-stages.js';

        // Get enabled items for each category (including custom items)
        function getEnabledItems(category, allItems, getDefaultFn) {
            const defaultIds = getDefaultFn().map(i => i.id);
            const customItems = CriteriaStore.getCustomItems(category);

            // Filter built-in items to only enabled ones
            const enabledBuiltIn = allItems.filter(item =>
                CriteriaStore.isEnabled(category, item.id, defaultIds)
            );

            // Add custom items
            return [...enabledBuiltIn, ...customItems];
        }

        const enabledGreenFlags = getEnabledItems('greenFlags', greenFlags, getDefaultGreenFlags);
        const enabledRedFlags = getEnabledItems('redFlags', redFlags, getDefaultRedFlags);
        const enabledDealbreakers = getEnabledItems('dealbreakers', dealbreakers, getDefaultDealbreakers);
        const enabledInvestmentStages = getEnabledItems('investment', investmentStages, getDefaultInvestmentStages);

        const GREEN_TOTAL = enabledGreenFlags.length;
        const RED_TOTAL = enabledRedFlags.length;
        const DEALBREAKER_TOTAL = enabledDealbreakers.length;
        const INVESTMENT_TOTAL = enabledInvestmentStages.length;

        const profileId = getProfileIdFromUrl();
        if (!profileId) window.location.href = 'index.html';

        let profile = Store.getProfile(profileId);
        if (!profile) window.location.href = 'index.html';

        let currentTab = 'green';
        let pendingAction = null;

        // Update page title
        document.title = `${profile.name} - Vetted`;

        // Render profile info
        function renderProfileInfo() {
            const colors = getGradeColor(profile.grade);
            const initials = getInitials(profile.name);
            const avatarColor = getAvatarColor(profile.id);

            document.getElementById('profile-avatar').style.backgroundColor = avatarColor;
            document.getElementById('profile-avatar').textContent = escapeHtml(initials);
            document.getElementById('profile-name').textContent = escapeHtml(profile.name);

            const gradeEl = document.getElementById('profile-grade');
            gradeEl.className = `px-5 py-2 rounded-full text-xl font-bold ${colors.bg} ${colors.text}`;
            gradeEl.textContent = profile.grade;

            document.getElementById('profile-grade-desc').textContent = getGradeDescription(profile.grade);

            // Load notes
            document.getElementById('profile-notes').value = profile.notes || '';
        }

        // Render grade breakdown
        function renderGradeBreakdown() {
            const greenCount = profile.greenFlags.length;
            const redCount = profile.redFlags.length;
            const dbCount = profile.dealbreakers.length;
            const investmentCount = Array.isArray(profile.investmentStages) ? profile.investmentStages.length : 0;

            const greenPercent = (greenCount / GREEN_TOTAL) * 100;
            const redPercent = (redCount / RED_TOTAL) * 100;
            const dbPercent = (dbCount / DEALBREAKER_TOTAL) * 100;
            const investmentPercent = (investmentCount / INVESTMENT_TOTAL) * 100;

            document.getElementById('grade-breakdown').innerHTML = `
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-success">thumb_up</span>
                            <span class="font-medium text-text-primary">Green Flags</span>
                        </div>
                        <span class="text-sm font-semibold text-text-secondary">${greenCount} / ${GREEN_TOTAL}</span>
                    </div>
                    <div class="h-3 bg-bg-tertiary rounded-full overflow-hidden">
                        <div class="h-full bg-success rounded-full transition-all duration-500" style="width: ${greenPercent}%"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-error">flag</span>
                            <span class="font-medium text-text-primary">Red Flags</span>
                        </div>
                        <span class="text-sm font-semibold text-text-secondary">${redCount} / ${RED_TOTAL}</span>
                    </div>
                    <div class="h-3 bg-bg-tertiary rounded-full overflow-hidden">
                        <div class="h-full bg-error rounded-full transition-all duration-500" style="width: ${redPercent}%"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">block</span>
                            <span class="font-medium text-text-primary">Dealbreakers</span>
                        </div>
                        <span class="text-sm font-semibold text-text-secondary">${dbCount} / ${DEALBREAKER_TOTAL}</span>
                    </div>
                    <div class="h-3 bg-bg-tertiary rounded-full overflow-hidden">
                        <div class="h-full bg-primary rounded-full transition-all duration-500" style="width: ${dbPercent}%"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-info">trending_up</span>
                            <span class="font-medium text-text-primary">Investment</span>
                        </div>
                        <span class="text-sm font-semibold text-text-secondary">${investmentCount} / ${INVESTMENT_TOTAL}</span>
                    </div>
                    <div class="h-3 bg-bg-tertiary rounded-full overflow-hidden">
                        <div class="h-full bg-info rounded-full transition-all duration-500" style="width: ${investmentPercent}%"></div>
                    </div>
                </div>
            `;

            // Update tab counts
            document.getElementById('count-green').textContent = greenCount;
            document.getElementById('count-red').textContent = redCount;
            document.getElementById('count-dealbreakers').textContent = dbCount;
            document.getElementById('count-investment').textContent = investmentCount;
        }

        // Switch tab
        window.switchTab = function(tab) {
            currentTab = tab;

            // Update tab button styles with color-coded active states
            ['green', 'red', 'dealbreakers', 'investment'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                btn.classList.remove('active-green', 'active-red', 'active-dealbreakers', 'active-investment');
                if (t === tab) {
                    btn.classList.add(`active-${t}`);
                }
            });

            renderTabContent();
        };

        // Render tab content
        function renderTabContent() {
            const container = document.getElementById('tab-content');
            let html = '';

            if (currentTab === 'green') {
                html = `<div class="divide-y divide-border-default">
                    ${enabledGreenFlags.map(flag => renderFlagItem(flag, 'greenFlags', 'success', 'bg-success-bg', 'thumb_up')).join('')}
                </div>`;
            } else if (currentTab === 'red') {
                html = `<div class="divide-y divide-border-default">
                    ${enabledRedFlags.map(flag => renderFlagItem(flag, 'redFlags', 'error', 'bg-error-bg', 'flag')).join('')}
                </div>`;
            } else if (currentTab === 'dealbreakers') {
                html = `<div class="divide-y divide-border-default">
                    ${enabledDealbreakers.map(db => renderDealbreakerItem(db)).join('')}
                </div>`;
            } else if (currentTab === 'investment') {
                html = `<div class="divide-y divide-border-default">
                    ${enabledInvestmentStages.map(stage => renderInvestmentItem(stage)).join('')}
                </div>`;
            }

            container.innerHTML = html;

            // Add event listeners
            container.querySelectorAll('.flag-checkbox').forEach(cb => {
                cb.addEventListener('change', handleFlagToggle);
            });
            container.querySelectorAll('.investment-checkbox').forEach(cb => {
                cb.addEventListener('change', handleInvestmentToggle);
            });
        }

        function renderFlagItem(flag, flagType, colorClass, bgClass, iconName) {
            const isChecked = profile[flagType].includes(flag.id);
            const iconColor = isChecked ? `text-${colorClass}` : 'text-text-tertiary';
            const itemBg = isChecked ? bgClass : '';
            return `
                <label class="flag-item flex items-center gap-4 p-4 cursor-pointer ${itemBg}">
                    <input type="checkbox" class="flag-checkbox" data-flag-type="${flagType}" data-flag-id="${flag.id}" ${isChecked ? 'checked' : ''} />
                    <span class="flag-icon material-symbols-outlined ${iconColor} text-3xl shrink-0 ${isChecked ? 'icon-filled' : ''}">${iconName}</span>
                    <span class="text-text-primary text-base leading-relaxed">${escapeHtml(flag.label)}</span>
                </label>
            `;
        }

        function renderDealbreakerItem(db) {
            const isChecked = profile.dealbreakers.includes(db.id);
            const iconColor = isChecked ? 'text-primary' : 'text-text-tertiary';
            const itemBg = isChecked ? 'bg-primary/10' : '';
            return `
                <label class="flag-item flex items-start gap-4 p-4 cursor-pointer ${itemBg}">
                    <input type="checkbox" class="flag-checkbox" data-flag-type="dealbreakers" data-flag-id="${db.id}" ${isChecked ? 'checked' : ''} />
                    <span class="flag-icon material-symbols-outlined ${iconColor} text-3xl shrink-0 mt-0.5 ${isChecked ? 'icon-filled' : ''}">block</span>
                    <div class="flex-1 min-w-0">
                        <span class="text-text-primary text-base font-medium block mb-1">${escapeHtml(db.label)}</span>
                        <span class="text-text-secondary text-sm leading-relaxed block">${escapeHtml(db.explanation)}</span>
                    </div>
                </label>
            `;
        }

        function renderInvestmentItem(stage) {
            const checkedStages = Array.isArray(profile.investmentStages) ? profile.investmentStages : [];
            // Support both stage.stage (number) for built-in and stage.id for custom items
            const stageId = stage.id || stage.stage;
            const isChecked = checkedStages.includes(stageId) || checkedStages.includes(stage.stage);
            const iconColor = isChecked ? 'text-info' : 'text-text-tertiary';
            const itemBg = isChecked ? 'bg-info-bg' : '';
            const description = stage.description || '';
            return `
                <label class="flag-item flex items-start gap-4 p-4 cursor-pointer ${itemBg}">
                    <input type="checkbox" class="investment-checkbox" data-stage-id="${stageId}" ${isChecked ? 'checked' : ''} />
                    <span class="flag-icon material-symbols-outlined ${iconColor} text-3xl shrink-0 mt-0.5 ${isChecked ? 'icon-filled' : ''}">trending_up</span>
                    <div class="flex-1 min-w-0">
                        <span class="text-text-primary text-base font-medium block mb-1">${escapeHtml(stage.label)}</span>
                        ${description ? `<span class="text-text-secondary text-sm leading-relaxed block">${escapeHtml(description)}</span>` : ''}
                    </div>
                </label>
            `;
        }

        function handleFlagToggle(event) {
            const cb = event.target;
            const flagType = cb.dataset.flagType;
            const flagId = cb.dataset.flagId;
            const isChecked = cb.checked;

            profile = Store.toggleFlag(profileId, flagType, flagId, isChecked);

            renderProfileInfo();
            renderGradeBreakdown();
            renderTabContent();
        }

        function handleInvestmentToggle(event) {
            const cb = event.target;
            const rawStageId = cb.dataset.stageId;
            // Handle both numeric (built-in) and string (custom) stage IDs
            const stageId = rawStageId.startsWith('custom-') ? rawStageId : parseInt(rawStageId, 10);
            const isChecked = cb.checked;

            profile = Store.toggleInvestmentStage(profileId, stageId, isChecked);

            renderGradeBreakdown();
            renderTabContent();
        }

        // Notes autosave
        document.getElementById('profile-notes').addEventListener('input', (e) => {
            const notes = e.target.value;
            Store.updateProfileNotes(profileId, notes);
        });

        // Confirmation modals
        window.showArchiveConfirm = function() {
            pendingAction = 'archive';
            document.getElementById('confirm-title').textContent = 'Archive Profile';
            document.getElementById('confirm-message').textContent = `Are you sure you want to archive "${profile.name}"? You can restore it later from Archives.`;
            const btn = document.getElementById('confirm-action-btn');
            btn.className = 'flex-1 px-4 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-primary-hover transition-colors';
            btn.textContent = 'Archive';
            document.getElementById('confirm-modal').classList.remove('hidden');
        };

        window.showDeleteConfirm = function() {
            pendingAction = 'delete';
            document.getElementById('confirm-title').textContent = 'Delete Profile';
            document.getElementById('confirm-message').textContent = `Are you sure you want to permanently delete "${profile.name}"? This action cannot be undone.`;
            const btn = document.getElementById('confirm-action-btn');
            btn.className = 'flex-1 px-4 py-3 bg-error text-white rounded-xl font-semibold hover:bg-error/90 transition-colors';
            btn.textContent = 'Delete';
            document.getElementById('confirm-modal').classList.remove('hidden');
        };

        window.closeConfirmModal = function() {
            document.getElementById('confirm-modal').classList.add('hidden');
            pendingAction = null;
        };

        window.executeConfirmedAction = function() {
            if (pendingAction === 'archive') {
                Store.archiveProfile(profileId);
                window.location.href = 'index.html';
            } else if (pendingAction === 'delete') {
                Store.deleteProfile(profileId);
                window.location.href = 'index.html';
            }
        };

        // Initialize
        renderProfileInfo();
        renderGradeBreakdown();
        switchTab('green');
    </script>
</body>
</html>
